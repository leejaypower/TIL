# 메모리 교환, 스택, 힙

### 메모리 교환의 문제

```c
#include <stdio.h>

void swap(int a, int b);

int main(void)
{
    int x = 1;
    int y = 2;

    printf("x is %i, y is %i\n", x, y);
    swap(x, y);
    printf("x is %i, y is %i\n", x, y);
}

void swap(int a, int b)
{
    int tmp = a;
    a = b;
    b = tmp;
}
```

- 정수 a와 b를 인자로 받아서 두 변수의 값을 바꾸는게 목적인 swap 함수

- 두 변수를 바꾸기 위해 임시공간(변수 tmp)을 만들었다.

- 하지만 출력해보면 swap을 호출해도 값은 바뀌지 않는다.

<br>

이유는?

<b>함수에 인자를 전달할 때 그 값을 복사해서 전달하기 때문이다!</b><br>

- x와 y가 1, 2로 초기화 되어있고 함수에 인자를 전달하지만, 함수는 x와 y의 복사본을 전달받는다.

- 따라서 swap 함수는 제대로 동작하긴 하지만, 복사본을 바꾸기 때문에 x와 y의 값을 바꾸는 것은 아니다.

> 교환하는 대상이 x, y 그 자체가 아닌 함수 내에서 새롭게 정의된 a, b라는 것이며,<br> a와 b는 각각 x와 y의 값을 복제하여 가지게 된다. 서로 다른 메모리 주소에 저장되는 것이다.

<br>

### 메모리 영역

사람들이 컴파일러를 만들 때 메모리의 구조를 정해 놓았다. <br>
이렇게 메모리 구역을 구분한 이유는 메모리의 효율적인 실행과 접근을 위해서이다.

<img alt="메모리 저장구역" src="../images/memory_layout.png">

- 프로그램이 실행될 때, 0과 1로 컴파일된 머신코드는 메모리 위쪽에 저장된다.

- 프로그램이 전역 변수나 정보를 쓴다면 머신코드 아래 공간에 저장된다.

- 그 아래에는 <b>힙(Heap)</b>이라는 메모리 영역이 있다.

- 힙은 메모리를 할당 받을 수 있는 커다란 영역이다. <i>malloc</i>을 호출하면 메모리를 이 영역에서 가져오게 된다.

- 힙은 아래로 자라기 때문에 메모리를 사용할 수록 아래로 내려간다.

- 함수의 지역 변수들은 <b>스택(stack)</b>이라는 메모리 제일 아래 영역에 놓인다.

<br>

### 이제 위의 교환 예제에 대해서 다시 생각해보자.

- 프로그램이 시작하고 main이 호출되면, x와 y라는 두 변수가 선언되고, 각각 1과 2로 초기화 되어서 stack 메모리 맨 아래에 쌓인다.

- 그리고 swap을 호출하면 컴퓨터가 스택에 또 다른 영역을 할당해준다.

- swap의 , b, tmp로 세 개의 변수는 x, y 변수 위에 쌓인다.

```c
int tmp = a;
a = b;
b = tmp;
```

- 이 세줄의 코드로 인해 a와 b는 성공적으로 교환이 되어진다.

- 그러나 교환이 완료되면, 완료된 코드들은 프로그램을 위해 더 이상 사용되지 않는다.(stack 메모리의 특성)

- 교환 이후에도 main 함수는 남아있지만 a와 b의 값만 바뀔 뿐, x와 y는 swap 함수의 영향을 전혀 받지 않는다.

<br>

<b>이 문제를 근본적으로 해결하려면 포인터를 이용해야 한다.</b>

<img alt="메모리 저장구역" src="../images/pointers.png">

<br>

```c
#include <stdio.h>

void swap(int *a, int *b);

int main(void)
{
    int x = 1;
    int y = 2;

    printf("x is %i, y is %i\n", x, y);
    swap(&x, &y);
    // x와 y 변수의 주소를 swap함수의 인자로 넘겨준다.
    printf("x is %i, y is %i\n", x, y);
}

void swap(int *a, int *b)
    // 정수(x),(y)의 주소를 받아 a, b라고 부른다.
{
    int tmp = *a;
    // x의 주소로 가서 x의 값인 1을 변수 tmp에 할당한다.
    *a = *b;
    *b = tmp;
}
```

- main에서 x와 y의 값을 swap에게 전달하지 않고, x와 y의 주소를 알려주게 한다.

- 그리고 swap 함수가 그 주소로 가서 값을 바꾸게 한다.

- swap 함수가 반환되서 변수 a와 b, tmp가 사라져도 괜찮다. x와 y 자체의 값을 교환했기 때문이다.

<br>
<hr>
<a href="https://www.boostcourse.org/cs112">모두를 위한 컴퓨터과학(CS50 2019)</a> - 메모리 교환, 스택, 힙으로 공부한 내용입니다.
